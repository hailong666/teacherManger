import{r as m,v as ut,c as D,o as rt,y as r,d as o,e as c,f,g as a,w as n,h as l,F as E,z as L,i as v,l as x,t as b,B as it,E as F,m as B,C as ct,j,D as _t,G as mt}from"./main-34d96914.js";import{g as vt}from"./class-f7f45a5e.js";import{g as pt,b as q,u as ft}from"./attendance-fbbd8396.js";import{_ as bt}from"./_plugin-vue_export-helper-c27b6911.js";const yt={class:"classroom-attendance-container"},gt={class:"card-header"},wt={class:"header-actions"},Ct={key:0,class:"attendance-status"},kt={key:1,class:"student-list"},Vt={class:"list-header"},ht={class:"quick-actions"},St={class:"students-grid"},xt=["onClick"],At={class:"student-info"},Nt={class:"student-name"},Tt={class:"student-id"},Bt={class:"attendance-status"},It={key:2,class:"attendance-records"},Mt={class:"dialog-footer"},Rt={key:0,class:"stats-content"},$t={class:"stats-summary"},Ut={class:"stat-item"},zt={class:"stat-number"},Dt={class:"stat-item"},Et={class:"stat-number"},Lt={class:"stat-item"},Ft={class:"stat-number"},jt={class:"stat-item"},qt={class:"stat-number"},Gt={__name:"ClassroomAttendance",setup(Ot){const i=m(""),I=m(""),A=m([]),p=m([]),y=m(!1),k=m([]),C=m(!1),N=m(!1),g=m(null),d=ut({id:"",studentName:"",status:"",note:""}),M=D(()=>p.value.filter(e=>e.attended)),R=D(()=>p.value.filter(e=>!e.attended));rt(()=>{G()});const G=async()=>{try{const e=await vt();A.value=e.data.classes||[]}catch{r.error("获取班级列表失败")}},O=async()=>{if(i.value)try{const e=A.value.find(u=>u.id===i.value);I.value=(e==null?void 0:e.name)||"";const t=await it(i.value);p.value=t.data.class.students.map(u=>({...u,attended:!1})),await V()}catch{r.error("获取学生列表失败")}},V=async()=>{try{const e=new Date().toISOString().split("T")[0],t=await pt({classId:i.value,date:e});k.value=t.data.attendances||[],p.value.forEach(u=>{const w=k.value.find(_=>_.studentId===u.id);u.attended=!!w})}catch(e){console.error("获取今日签到记录失败:",e)}},P=()=>{y.value=!0,r.success("签到已开始，学生可以在白板上写名字进行签到")},H=async e=>{if(!y.value){r.warning("请先开始签到");return}try{e.attended?r.info(`${e.name} 已经签到过了`):(await q({classId:i.value,studentId:e.id,status:"present",note:"希沃白板签到"}),e.attended=!0,r.success(`${e.name} 签到成功`)),await V()}catch{r.error("签到操作失败")}},J=async()=>{if(!y.value){r.warning("请先开始签到");return}try{await F.confirm("确定要将所有学生标记为出勤吗？","确认操作",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"});const e=p.value.filter(t=>!t.attended);for(const t of e)await q({classId:i.value,studentId:t.id,status:"present",note:"批量标记出勤"}),t.attended=!0;await V(),r.success("所有学生已标记为出勤")}catch(e){e!=="cancel"&&r.error("批量签到失败")}},K=async()=>{try{await F.confirm("确定要重置今日签到记录吗？此操作不可恢复！","确认操作",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),p.value.forEach(e=>{e.attended=!1}),k.value=[],y.value=!1,r.success("签到记录已重置")}catch(e){e!=="cancel"&&r.error("重置失败")}},Q=e=>{d.id=e.id,d.studentName=e.studentName,d.status=e.status,d.note=e.note||"",C.value=!0},W=async()=>{try{await ft({id:d.id,status:d.status,note:d.note}),C.value=!1,await V(),r.success("签到记录更新成功")}catch{r.error("更新签到记录失败")}},X=()=>{const e=p.value.length,t=M.value.length,u=R.value.length,w=e>0?Math.round(t/e*100):0;g.value={totalStudents:e,presentCount:t,absentCount:u,attendanceRate:w},N.value=!0},Y=e=>new Date(e).toLocaleString("zh-CN"),Z=e=>({present:"success",late:"warning",absent:"danger",leave:"info"})[e]||"info",tt=e=>({present:"出勤",late:"迟到",absent:"缺勤",leave:"请假"})[e]||e;return(e,t)=>{const u=o("el-option"),w=o("el-select"),_=o("el-button"),et=o("el-alert"),$=o("el-icon"),h=o("el-table-column"),at=o("el-tag"),st=o("el-table"),nt=o("el-card"),U=o("el-input"),T=o("el-form-item"),lt=o("el-form"),z=o("el-dialog"),S=o("el-col"),ot=o("el-row");return c(),f("div",yt,[a(nt,{class:"attendance-card"},{header:n(()=>[l("div",gt,[t[9]||(t[9]=l("h3",null,"教室签到管理",-1)),l("div",wt,[a(w,{modelValue:i.value,"onUpdate:modelValue":t[0]||(t[0]=s=>i.value=s),placeholder:"选择班级",onChange:O},{default:n(()=>[(c(!0),f(E,null,L(A.value,s=>(c(),B(u,{key:s.id,label:s.name,value:s.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),a(_,{type:"primary",onClick:P,disabled:!i.value},{default:n(()=>[...t[7]||(t[7]=[v("开始签到",-1)])]),_:1},8,["disabled"]),a(_,{onClick:X,disabled:!i.value},{default:n(()=>[...t[8]||(t[8]=[v("查看统计",-1)])]),_:1},8,["disabled"])])])]),default:n(()=>[y.value?(c(),f("div",Ct,[a(et,{title:"签到进行中",type:"success",description:`当前班级：${I.value} | 已签到：${M.value.length}人 | 未签到：${R.value.length}人`,"show-icon":"",closable:!1},null,8,["description"])])):x("",!0),i.value?(c(),f("div",kt,[l("div",Vt,[t[12]||(t[12]=l("h4",null,"学生名单",-1)),l("div",ht,[a(_,{size:"small",onClick:J},{default:n(()=>[...t[10]||(t[10]=[v("全部出勤",-1)])]),_:1}),a(_,{size:"small",onClick:K},{default:n(()=>[...t[11]||(t[11]=[v("重置签到",-1)])]),_:1})])]),l("div",St,[(c(!0),f(E,null,L(p.value,s=>(c(),f("div",{key:s.id,class:ct(["student-card",{attended:s.attended,"not-attended":!s.attended&&y.value}]),onClick:dt=>H(s)},[l("div",At,[l("div",Nt,b(s.name),1),l("div",Tt,"学号: "+b(s.username),1)]),l("div",Bt,[s.attended?(c(),B($,{key:0,class:"check-icon"},{default:n(()=>[a(j(_t))]),_:1})):(c(),B($,{key:1,class:"pending-icon"},{default:n(()=>[a(j(mt))]),_:1}))])],10,xt))),128))])])):x("",!0),y.value?(c(),f("div",It,[t[14]||(t[14]=l("h4",null,"今日签到记录",-1)),a(st,{data:k.value,style:{width:"100%"}},{default:n(()=>[a(h,{prop:"studentName",label:"学生姓名",width:"120"}),a(h,{prop:"attendanceTime",label:"签到时间",width:"180"},{default:n(s=>[v(b(Y(s.row.attendanceTime)),1)]),_:1}),a(h,{prop:"status",label:"状态",width:"100"},{default:n(s=>[a(at,{type:Z(s.row.status)},{default:n(()=>[v(b(tt(s.row.status)),1)]),_:2},1032,["type"])]),_:1}),a(h,{label:"操作",width:"120"},{default:n(s=>[a(_,{size:"small",onClick:dt=>Q(s.row)},{default:n(()=>[...t[13]||(t[13]=[v("编辑",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])])):x("",!0)]),_:1}),a(z,{modelValue:C.value,"onUpdate:modelValue":t[5]||(t[5]=s=>C.value=s),title:"编辑签到记录",width:"400px"},{footer:n(()=>[l("span",Mt,[a(_,{onClick:t[4]||(t[4]=s=>C.value=!1)},{default:n(()=>[...t[15]||(t[15]=[v("取消",-1)])]),_:1}),a(_,{type:"primary",onClick:W},{default:n(()=>[...t[16]||(t[16]=[v("保存",-1)])]),_:1})])]),default:n(()=>[a(lt,{model:d,"label-width":"80px"},{default:n(()=>[a(T,{label:"学生"},{default:n(()=>[a(U,{modelValue:d.studentName,"onUpdate:modelValue":t[1]||(t[1]=s=>d.studentName=s),disabled:""},null,8,["modelValue"])]),_:1}),a(T,{label:"状态"},{default:n(()=>[a(w,{modelValue:d.status,"onUpdate:modelValue":t[2]||(t[2]=s=>d.status=s),placeholder:"选择状态"},{default:n(()=>[a(u,{label:"出勤",value:"present"}),a(u,{label:"迟到",value:"late"}),a(u,{label:"缺勤",value:"absent"}),a(u,{label:"请假",value:"leave"})]),_:1},8,["modelValue"])]),_:1}),a(T,{label:"备注"},{default:n(()=>[a(U,{modelValue:d.note,"onUpdate:modelValue":t[3]||(t[3]=s=>d.note=s),type:"textarea",rows:"3"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),a(z,{modelValue:N.value,"onUpdate:modelValue":t[6]||(t[6]=s=>N.value=s),title:"签到统计",width:"600px"},{default:n(()=>[g.value?(c(),f("div",Rt,[l("div",$t,[a(ot,{gutter:20},{default:n(()=>[a(S,{span:6},{default:n(()=>[l("div",Ut,[l("div",zt,b(g.value.totalStudents),1),t[17]||(t[17]=l("div",{class:"stat-label"},"总人数",-1))])]),_:1}),a(S,{span:6},{default:n(()=>[l("div",Dt,[l("div",Et,b(g.value.presentCount),1),t[18]||(t[18]=l("div",{class:"stat-label"},"已签到",-1))])]),_:1}),a(S,{span:6},{default:n(()=>[l("div",Lt,[l("div",Ft,b(g.value.absentCount),1),t[19]||(t[19]=l("div",{class:"stat-label"},"未签到",-1))])]),_:1}),a(S,{span:6},{default:n(()=>[l("div",jt,[l("div",qt,b(g.value.attendanceRate)+"%",1),t[20]||(t[20]=l("div",{class:"stat-label"},"出勤率",-1))])]),_:1})]),_:1})])])):x("",!0)]),_:1},8,["modelValue"])])}}},Qt=bt(Gt,[["__scopeId","data-v-064fbac9"]]);export{Qt as default};
