import{b as le,r as p,v as re,c as S,o as ie,d as k,e as r,f as d,h as a,t as i,g as c,w as l,l as B,j as F,T as ce,y as o,i as _,F as V,z as L,m as H,E as de}from"./main-2e31a8b5.js";import{_ as ue}from"./_plugin-vue_export-helper-c27b6911.js";const ve={class:"whiteboard-attendance"},he={class:"header-info"},me={class:"class-info"},ge={class:"attendance-stats"},pe={class:"whiteboard-container"},_e={class:"whiteboard-header"},fe={class:"whiteboard-controls"},ye={class:"canvas-container"},we={key:0,class:"canvas-placeholder"},ke={key:0,class:"manual-attendance"},be={class:"manual-form"},Ie={key:0,style:{color:"#67c23a","margin-left":"10px"}},Te={class:"attendance-stats-section"},Se={class:"stats-summary"},xe={class:"stat-item"},Ce={class:"stat-value"},De={class:"stat-item"},Be={class:"stat-value present"},Ae={class:"stat-item"},$e={class:"stat-value absent"},je={class:"stat-item"},Ne={class:"stat-value"},ze={class:"attendance-list"},Ee={class:"list-header"},Me={class:"header-actions"},Oe={key:0,class:"empty-state"},Ve={key:1,class:"student-grid"},Le={class:"student-name"},Pe={class:"attendance-time"},Re={class:"attendance-method"},We={key:1,class:"student-list"},Je={class:"student-grid"},Ue={class:"student-name"},Xe={class:"student-info"},Ye={key:2,class:"all-attended"},qe={__name:"WhiteboardAttendance",setup(Fe){const A=le(),x=p(!1),C=p(!1),$=p(!1);p("attended");const b=p(""),h=re({id:null,name:"",teacherId:null}),m=p([]),f=p([]),I=p(null);let v=null,j=0,N=0;const y=S(()=>f.value.filter(t=>t.status==="present").length),z=S(()=>m.value.length-y.value),E=S(()=>f.value.filter(t=>t.status==="present").map(t=>t.studentId)),P=S(()=>m.value.filter(t=>!E.value.includes(t.id))),G=S(()=>m.value.length===0?0:Math.round(y.value/m.value.length*100));S(()=>f.value.map(t=>({id:t.id,studentName:t.studentName,attendanceTime:new Date(t.attendanceTime).toLocaleString(),method:t.method})));const K=()=>{ce(()=>{const t=I.value;t&&(v=t.getContext("2d"),t.width=t.offsetWidth,t.height=t.offsetHeight,v.strokeStyle="#2c3e50",v.lineWidth=3,v.lineCap="round",v.lineJoin="round")})},R=t=>{const s=I.value.getBoundingClientRect();return t.touches?{x:t.touches[0].clientX-s.left,y:t.touches[0].clientY-s.top}:{x:t.clientX-s.left,y:t.clientY-s.top}},W=t=>{t.preventDefault(),$.value=!0;const e=R(t);j=e.x,N=e.y},J=t=>{if(!$.value)return;t.preventDefault();const e=R(t);v.beginPath(),v.moveTo(j,N),v.lineTo(e.x,e.y),v.stroke(),j=e.x,N=e.y,C.value=!0},U=t=>{t.preventDefault(),$.value=!1},X=()=>{v&&(v.clearRect(0,0,I.value.width,I.value.height),C.value=!1)},Q=async()=>{var t,e;if(!C.value){o.warning("请先在白板上写下您的姓名");return}try{const g=I.value.toDataURL("image/png"),u={classId:h.id,method:"signature",signatureData:g,notes:"希沃白板手写签到"};((e=(t=A.userInfo)==null?void 0:t.role)==null?void 0:e.name)==="student"&&(u.studentId=A.userInfo.id);const w=await fetch("/api/attendance/create",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("teacher-manager-token")}`},body:JSON.stringify(u)}),M=await w.json();w.ok?(o.success("签到成功！"),X(),await T()):o.error(M.message||"签到失败")}catch(s){console.error("签到失败:",s),o.error("签到失败，请重试")}},Z=async()=>{if(!b.value){o.warning("请选择学生");return}try{const t=await fetch("/api/attendance/create",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("teacher-manager-token")}`},body:JSON.stringify({classId:h.id,studentId:b.value,method:"manual",notes:"教师手动签到"})}),e=await t.json();t.ok?(o.success("手动签到成功！"),b.value="",await T()):o.error(e.message||"手动签到失败")}catch(t){console.error("手动签到失败:",t),o.error("手动签到失败，请重试")}},ee=async()=>{try{x.value=!0;const t=await fetch("/api/classes",{headers:{Authorization:`Bearer ${localStorage.getItem("teacher-manager-token")}`}});if(t.ok){const e=await t.json();if(console.log("获取到的班级数据:",e),e&&e.classes&&e.classes.length>0){const s=e.classes[0];h.id=s.id,h.name=s.name,h.teacherId=s.teacherId,console.log("设置班级信息:",h),await te(s.id)}else console.warn("没有找到班级数据:",e),o.warning("没有找到可用的班级")}else{const e=await t.json().catch(()=>({}));console.error("获取班级信息失败:",t.status,e),o.error(`获取班级信息失败: ${e.message||t.statusText}`)}}catch(t){console.error("获取班级信息失败:",t),o.error("获取班级信息失败，请检查网络连接")}finally{x.value=!1}},te=async t=>{try{const e=await fetch(`/api/classes/${t}/students`,{headers:{Authorization:`Bearer ${localStorage.getItem("teacher-manager-token")}`}});if(e.ok){const s=await e.json();console.log("获取到的班级学生数据:",s),m.value=s.students||[]}else{const s=await e.json().catch(()=>({}));console.error("获取班级学生失败:",e.status,s),o.error(`获取班级学生失败: ${s.message||e.statusText}`),m.value=[]}}catch(e){console.error("获取班级学生失败:",e),o.error("获取班级学生失败"),m.value=[]}},T=async()=>{if(h.id)try{x.value=!0;const t=new Date().toISOString().split("T")[0],e=await fetch(`/api/attendance?classId=${h.id}&date=${t}`,{headers:{Authorization:`Bearer ${localStorage.getItem("teacher-manager-token")}`}});if(e.ok){const s=await e.json();console.log("获取到的签到记录数据:",s);const g=s.attendances||[];f.value=g.map(u=>{var w;return{id:u.id,studentId:u.studentId,studentName:u.studentName||((w=u.student)==null?void 0:w.name),attendanceTime:u.attendanceTime||u.class_time,method:u.method,status:"present"}})}else{const s=await e.json().catch(()=>({}));console.error("获取签到列表失败:",e.status,s),o.error(`获取签到记录失败: ${s.message||e.statusText}`),f.value=[]}}catch(t){console.error("获取签到记录失败:",t),o.error("获取签到记录失败"),f.value=[]}finally{x.value=!1}},ae=async t=>{try{const e=await fetch("/api/attendance/create",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("teacher-manager-token")}`},body:JSON.stringify({classId:h.id,studentId:t.id,method:"manual",notes:"教师快速签到"})}),s=await e.json();e.ok?(o.success(`${t.name} 签到成功！`),await T()):o.error(s.message||"快速签到失败")}catch(e){console.error("快速签到失败:",e),o.error("快速签到失败，请重试")}},se=async()=>{try{await de.confirm("确定要清除所有签到记录吗？此操作不可恢复！","警告",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"});const t=await fetch("/api/attendance/clear/all",{method:"DELETE",headers:{Authorization:`Bearer ${localStorage.getItem("teacher-manager-token")}`}}),e=await t.json();t.ok?(o.success("所有签到记录已清除"),await T()):o.error(e.message||"清除记录失败")}catch(t){t!=="cancel"&&(console.error("清除签到记录失败:",t),o.error("清除签到记录失败，请重试"))}},ne=t=>t?new Date(t).toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit",second:"2-digit"}):"";return ie(async()=>{await ee(),await T(),K()}),(t,e)=>{var Y,q;const s=k("el-tag"),g=k("el-button"),u=k("el-button-group"),w=k("el-option"),M=k("el-select"),D=k("el-card"),oe=k("el-result");return r(),d("div",ve,[a("div",he,[a("div",me,[a("h2",null,i(h.name||"班级签到"),1),e[1]||(e[1]=a("p",null,"请在下方白板上写下您的姓名进行签到",-1))]),a("div",ge,[c(s,{type:"success",size:"large"},{default:l(()=>[_("已签到: "+i(y.value)+"人",1)]),_:1}),c(s,{type:"warning",size:"large",style:{"margin-left":"10px"}},{default:l(()=>[_("未签到: "+i(z.value)+"人",1)]),_:1})])]),a("div",pe,[a("div",_e,[e[4]||(e[4]=a("h3",null,"签到白板",-1)),a("div",fe,[c(u,null,{default:l(()=>[c(g,{onClick:X,type:"warning"},{default:l(()=>[...e[2]||(e[2]=[_("清空画板",-1)])]),_:1}),c(g,{onClick:Q,type:"primary",disabled:!C.value},{default:l(()=>[...e[3]||(e[3]=[_("提交签到",-1)])]),_:1},8,["disabled"])]),_:1})])]),a("div",ye,[a("canvas",{ref_key:"signatureCanvas",ref:I,onMousedown:W,onMousemove:J,onMouseup:U,onTouchstart:W,onTouchmove:J,onTouchend:U,class:"signature-canvas"},null,544),C.value?B("",!0):(r(),d("div",we,[...e[5]||(e[5]=[a("p",null,"请在此处写下您的姓名",-1)])]))])]),((q=(Y=F(A).userInfo)==null?void 0:Y.role)==null?void 0:q.name)==="teacher"?(r(),d("div",ke,[c(D,null,{header:l(()=>[...e[6]||(e[6]=[a("h3",null,"手动添加签到",-1)])]),default:l(()=>[a("div",be,[c(M,{modelValue:b.value,"onUpdate:modelValue":e[0]||(e[0]=n=>b.value=n),placeholder:"选择学生",style:{width:"200px","margin-right":"10px"},filterable:""},{default:l(()=>[(r(!0),d(V,null,L(m.value,n=>(r(),H(w,{key:n.id,label:n.name,value:n.id,disabled:E.value.includes(n.id)},{default:l(()=>[a("span",null,i(n.name),1),E.value.includes(n.id)?(r(),d("span",Ie,"已签到")):B("",!0)]),_:2},1032,["label","value","disabled"]))),128))]),_:1},8,["modelValue"]),c(g,{onClick:Z,type:"success",disabled:!b.value},{default:l(()=>[...e[7]||(e[7]=[_("手动签到",-1)])]),_:1},8,["disabled"])])]),_:1})])):B("",!0),a("div",Te,[c(D,null,{header:l(()=>[...e[8]||(e[8]=[a("h3",null,"签到统计",-1)])]),default:l(()=>[a("div",Se,[a("div",xe,[e[9]||(e[9]=a("span",{class:"stat-label"},"总人数:",-1)),a("span",Ce,i(m.value.length),1)]),a("div",De,[e[10]||(e[10]=a("span",{class:"stat-label"},"已签到:",-1)),a("span",Be,i(y.value),1)]),a("div",Ae,[e[11]||(e[11]=a("span",{class:"stat-label"},"未签到:",-1)),a("span",$e,i(z.value),1)]),a("div",je,[e[12]||(e[12]=a("span",{class:"stat-label"},"签到率:",-1)),a("span",Ne,i(G.value)+"%",1)])])]),_:1})]),a("div",ze,[c(D,null,{header:l(()=>{var n,O;return[a("div",Ee,[a("h3",null,"已签到学生 ("+i(y.value)+"人)",1),a("div",Me,[c(g,{onClick:T,loading:x.value},{default:l(()=>[...e[13]||(e[13]=[_("刷新",-1)])]),_:1},8,["loading"]),((O=(n=F(A).userInfo)==null?void 0:n.role)==null?void 0:O.name)==="teacher"?(r(),H(g,{key:0,onClick:se,type:"danger",disabled:y.value===0},{default:l(()=>[...e[14]||(e[14]=[_(" 清除所有记录 ",-1)])]),_:1},8,["disabled"])):B("",!0)])])]}),default:l(()=>[y.value===0?(r(),d("div",Oe,[...e[15]||(e[15]=[a("p",null,"暂无签到记录",-1)])])):(r(),d("div",Ve,[(r(!0),d(V,null,L(f.value.filter(n=>n.status==="present"),n=>(r(),d("div",{key:n.id,class:"student-card attended"},[a("div",Le,i(n.studentName),1),a("div",Pe,i(ne(n.attendanceTime)),1),a("div",Re,i(n.method==="signature"?"手写签到":"手动签到"),1)]))),128))]))]),_:1})]),P.value.length>0?(r(),d("div",We,[c(D,null,{header:l(()=>[a("h3",null,"未签到学生 ("+i(z.value)+"人)",1)]),default:l(()=>[a("div",Je,[(r(!0),d(V,null,L(P.value,n=>(r(),d("div",{key:n.id,class:"student-card unattended"},[a("div",Ue,i(n.name),1),a("div",Xe,i(n.username||n.studentId||n.id),1),c(g,{size:"small",type:"primary",onClick:O=>ae(n),style:{"margin-top":"8px"}},{default:l(()=>[...e[16]||(e[16]=[_(" 快速签到 ",-1)])]),_:1},8,["onClick"])]))),128))])]),_:1})])):m.value.length>0?(r(),d("div",Ye,[c(D,null,{default:l(()=>[c(oe,{icon:"success",title:"全部学生已签到","sub-title":"今日所有学生都已完成签到"})]),_:1})])):B("",!0)])}}},Ke=ue(qe,[["__scopeId","data-v-fecd060a"]]);export{Ke as default};
