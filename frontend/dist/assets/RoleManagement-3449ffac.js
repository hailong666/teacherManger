import{r as f,v as H,c as J,o as K,d as u,x as W,e as d,f as c,h as r,g as o,w as a,L as X,y as p,P as Y,i as m,A as Z,m as k,F as w,z as h,l as ee,t as _,Q as se,R as le,E as te,S as ae}from"./main-2e31a8b5.js";import{_ as oe}from"./_plugin-vue_export-helper-c27b6911.js";const ne={class:"role-management"},ie={class:"page-header"},re={class:"permissions-tags"},de={key:0,class:"no-permissions"},ue={class:"permissions-selection"},me={class:"permission-items"},ce={class:"permission-desc"},pe={class:"dialog-footer"},_e={class:"card-header"},fe={class:"permissions-list"},ve={class:"permission-items"},ge={class:"permission-desc"},be={__name:"RoleManagement",setup(ye){const x=f(!1),V=f(!1),D=f([]),z=f([]),v=f(!1),b=f(!1),y=f(null),n=H({id:null,name:"",description:"",permission_ids:[]}),U={name:[{required:!0,message:"请输入角色名称",trigger:"blur"},{min:2,max:20,message:"角色名称长度在 2 到 20 个字符",trigger:"blur"}],description:[{required:!0,message:"请输入角色描述",trigger:"blur"}]},B=J(()=>{const s={用户管理:[],班级管理:[],考勤管理:[],作业管理:[],系统管理:[],其他:[]};return z.value.forEach(e=>{const t=e.name;t.includes("user")||t.includes("用户")?s.用户管理.push(e):t.includes("class")||t.includes("班级")?s.班级管理.push(e):t.includes("attendance")||t.includes("考勤")?s.考勤管理.push(e):t.includes("assignment")||t.includes("homework")||t.includes("作业")?s.作业管理.push(e):t.includes("admin")||t.includes("system")||t.includes("系统")?s.系统管理.push(e):s.其他.push(e)}),Object.entries(s).filter(([e,t])=>t.length>0).map(([e,t])=>({name:e,permissions:t}))}),R=async()=>{x.value=!0;try{const s=await X();D.value=s.roles||[]}catch(s){console.error("加载角色列表失败:",s),p.error("加载角色列表失败")}finally{x.value=!1}},F=async()=>{try{const s=await Y();z.value=s.permissions||[]}catch(s){console.error("加载权限列表失败:",s),p.error("加载权限列表失败")}},$=()=>{b.value=!1,T(),v.value=!0},A=s=>{b.value=!0,n.id=s.id,n.name=s.name,n.description=s.description,n.permission_ids=s.permissions?s.permissions.map(e=>e.id):[],v.value=!0},L=async()=>{if(y.value)try{await y.value.validate(),V.value=!0;const s={name:n.name,description:n.description,permission_ids:n.permission_ids};b.value?(await se(n.id,s),p.success("角色更新成功")):(await le(s),p.success("角色创建成功")),v.value=!1,R()}catch(s){console.error("保存角色失败:",s),p.error("保存角色失败")}finally{V.value=!1}},P=async s=>{if(s.name==="admin"){p.warning("管理员角色不能删除");return}try{await te.confirm(`确定要删除角色 "${s.name}" 吗？此操作不可恢复！`,"警告",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),await ae(s.id),p.success("角色删除成功"),R()}catch(e){e!=="cancel"&&(console.error("删除角色失败:",e),p.error("删除角色失败"))}},T=()=>{n.id=null,n.name="",n.description="",n.permission_ids=[],y.value&&y.value.resetFields()},q=s=>s?new Date(s).toLocaleString("zh-CN"):"-";return K(()=>{R(),F()}),(s,e)=>{const t=u("el-button"),g=u("el-table-column"),E=u("el-tag"),I=u("el-table"),M=u("el-card"),N=u("el-input"),C=u("el-form-item"),S=u("el-checkbox"),j=u("el-checkbox-group"),O=u("el-form"),Q=u("el-dialog"),G=W("loading");return d(),c("div",ne,[r("div",ie,[e[6]||(e[6]=r("h2",null,"角色管理",-1)),o(t,{type:"primary",onClick:$},{default:a(()=>[...e[5]||(e[5]=[m("新增角色",-1)])]),_:1})]),o(M,{class:"table-card"},{default:a(()=>[Z((d(),k(I,{data:D.value,style:{width:"100%"}},{default:a(()=>[o(g,{prop:"id",label:"ID",width:"80"}),o(g,{prop:"name",label:"角色名称",width:"150"}),o(g,{prop:"description",label:"描述","min-width":"200"}),o(g,{label:"权限","min-width":"300"},{default:a(l=>[r("div",re,[(d(!0),c(w,null,h(l.row.permissions,i=>(d(),k(E,{key:i.id,size:"small",style:{"margin-right":"5px","margin-bottom":"5px"}},{default:a(()=>[m(_(i.name),1)]),_:2},1024))),128)),!l.row.permissions||l.row.permissions.length===0?(d(),c("span",de," 无权限 ")):ee("",!0)])]),_:1}),o(g,{prop:"created_at",label:"创建时间",width:"180"},{default:a(l=>[m(_(q(l.row.created_at)),1)]),_:1}),o(g,{label:"操作",width:"150"},{default:a(l=>[o(t,{size:"small",onClick:i=>A(l.row)},{default:a(()=>[...e[7]||(e[7]=[m("编辑",-1)])]),_:1},8,["onClick"]),o(t,{size:"small",type:"danger",onClick:i=>P(l.row),disabled:l.row.name==="admin"},{default:a(()=>[...e[8]||(e[8]=[m(" 删除 ",-1)])]),_:1},8,["onClick","disabled"])]),_:1})]),_:1},8,["data"])),[[G,x.value]])]),_:1}),o(Q,{modelValue:v.value,"onUpdate:modelValue":e[4]||(e[4]=l=>v.value=l),title:b.value?"编辑角色":"新增角色",width:"600px"},{footer:a(()=>[r("span",pe,[o(t,{onClick:e[3]||(e[3]=l=>v.value=!1)},{default:a(()=>[...e[9]||(e[9]=[m("取消",-1)])]),_:1}),o(t,{type:"primary",onClick:L,loading:V.value},{default:a(()=>[...e[10]||(e[10]=[m("保存",-1)])]),_:1},8,["loading"])])]),default:a(()=>[o(O,{model:n,rules:U,ref_key:"roleFormRef",ref:y,"label-width":"80px"},{default:a(()=>[o(C,{label:"角色名称",prop:"name"},{default:a(()=>[o(N,{modelValue:n.name,"onUpdate:modelValue":e[0]||(e[0]=l=>n.name=l),disabled:b.value&&n.name==="admin"},null,8,["modelValue","disabled"])]),_:1}),o(C,{label:"描述",prop:"description"},{default:a(()=>[o(N,{modelValue:n.description,"onUpdate:modelValue":e[1]||(e[1]=l=>n.description=l),type:"textarea",rows:3},null,8,["modelValue"])]),_:1}),o(C,{label:"权限",prop:"permissions"},{default:a(()=>[r("div",ue,[o(j,{modelValue:n.permission_ids,"onUpdate:modelValue":e[2]||(e[2]=l=>n.permission_ids=l)},{default:a(()=>[(d(!0),c(w,null,h(B.value,l=>(d(),c("div",{class:"permission-category",key:l.name},[r("h4",null,_(l.name),1),r("div",me,[(d(!0),c(w,null,h(l.permissions,i=>(d(),k(S,{key:i.id,label:i.id,value:i.id},{default:a(()=>[m(_(i.name)+" ",1),r("span",ce,_(i.description),1)]),_:2},1032,["label","value"]))),128))])]))),128))]),_:1},8,["modelValue"])])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"]),o(M,{class:"permissions-card",style:{"margin-top":"20px"}},{header:a(()=>[r("div",_e,[e[12]||(e[12]=r("h3",null,"系统权限",-1)),o(t,{type:"primary",size:"small",onClick:F},{default:a(()=>[...e[11]||(e[11]=[m("刷新权限",-1)])]),_:1})])]),default:a(()=>[r("div",fe,[(d(!0),c(w,null,h(B.value,l=>(d(),c("div",{class:"permission-category",key:l.name},[r("h4",null,_(l.name),1),r("div",ve,[(d(!0),c(w,null,h(l.permissions,i=>(d(),k(E,{key:i.id,size:"small",style:{"margin-right":"10px","margin-bottom":"5px"}},{default:a(()=>[m(_(i.name)+" ",1),r("span",ge,_(i.description),1)]),_:2},1024))),128))])]))),128))])]),_:1})])}}},ke=oe(be,[["__scopeId","data-v-a3910314"]]);export{ke as default};
