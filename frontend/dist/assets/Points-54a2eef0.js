import{B as U,r as u,v as D,o as oe,d as p,x as ne,e as m,f as V,g as t,w as s,y as f,h as c,F as L,z as S,i as b,A as G,m as C,I as re,t as F,E as de}from"./main-2e31a8b5.js";import{g as ie}from"./class-419f1a29.js";import{b as ue}from"./randomCall-ab3a2a94.js";import{_ as pe}from"./_plugin-vue_export-helper-c27b6911.js";function ce(v){return U({url:"/points/add",method:"post",data:v})}function me(v){return U({url:"/points/student",method:"get",params:v})}function ge(v){return U({url:`/points/leaderboard/${v}`,method:"get"})}function fe(v){return U({url:`/points/${v}`,method:"delete"})}const ve={class:"points-container"},_e={class:"add-points-section"},be={class:"card-header"},ye={class:"leaderboard-section"},we={class:"card-header"},he={class:"records-section"},Ce={__name:"Points",setup(v){u(!1);const N=u(!1),$=u(!1),q=u(!1),x=u(!1),k=u(!1),E=u(),y=u([]),w=u([]),P=u([]),z=u([]),h=u(""),r=D({classId:"",studentId:"",points:1,reason:""}),B=D({classId:""}),d=D({page:1,limit:10,total:0}),H={classId:[{required:!0,message:"请选择班级",trigger:"change"}],studentId:[{required:!0,message:"请选择学生",trigger:"change"}],points:[{required:!0,message:"请输入积分",trigger:"blur"}],reason:[{required:!0,message:"请输入积分原因",trigger:"blur"}]},J=async()=>{var o,e;$.value=!0;try{const l=await ie();l&&l.classes?y.value=l.classes:y.value=[]}catch(l){f.error("获取班级列表失败："+(((e=(o=l.response)==null?void 0:o.data)==null?void 0:e.message)||l.message)),y.value=[]}finally{$.value=!1}},K=async()=>{var o,e;if(!r.classId){w.value=[];return}q.value=!0;try{const l=await ue(r.classId);l&&l.students?w.value=l.students:w.value=[]}catch(l){f.error("获取学生列表失败："+(((e=(o=l.response)==null?void 0:o.data)==null?void 0:e.message)||l.message)),w.value=[]}finally{q.value=!1}},O=()=>{E.value.validate(async o=>{var e,l;if(o){N.value=!0;try{await ce(r),f.success("积分添加成功"),E.value.resetFields(),w.value=[],_(),h.value===r.classId&&R()}catch(n){f.error("添加积分失败："+(((l=(e=n.response)==null?void 0:e.data)==null?void 0:l.message)||n.message))}finally{N.value=!1}}})},R=async()=>{var o,e;if(!h.value){f.warning("请选择班级");return}x.value=!0;try{const l=await ge(h.value);l&&l.leaderboard?P.value=l.leaderboard:P.value=[]}catch(l){f.error("获取排行榜失败："+(((e=(o=l.response)==null?void 0:o.data)==null?void 0:e.message)||l.message)),P.value=[]}finally{x.value=!1}},_=async()=>{var o,e,l;k.value=!0;try{const n={page:d.page,limit:d.limit};B.classId&&(n.classId=B.classId);const g=await me(n);g&&g.pointsRecords?(z.value=g.pointsRecords,d.total=((o=g.pagination)==null?void 0:o.total)||0):(z.value=[],d.total=0)}catch(n){f.error("获取积分记录失败："+(((l=(e=n.response)==null?void 0:e.data)==null?void 0:l.message)||n.message)),z.value=[],d.total=0}finally{k.value=!1}},Q=o=>{f.info(`查看 ${o.studentName} 的积分详情`)},W=o=>{de.confirm("确定要删除这条积分记录吗？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(async()=>{var e,l;try{await fe(o.id),f.success("删除成功"),_(),h.value&&R()}catch(n){f.error("删除失败："+(((l=(e=n.response)==null?void 0:e.data)==null?void 0:l.message)||n.message))}}).catch(()=>{})},X=o=>{d.limit=o,d.page=1,_()},Y=o=>{d.page=o,_()},Z=o=>o===1?"rank-first":o===2?"rank-second":o===3?"rank-third":"";return oe(()=>{J(),_()}),(o,e)=>{const l=p("el-option"),n=p("el-select"),g=p("el-form-item"),ee=p("el-input-number"),ae=p("el-input"),I=p("el-button"),te=p("el-form"),A=p("el-card"),i=p("el-table-column"),M=p("el-tag"),T=p("el-table"),le=p("el-pagination"),j=ne("loading");return m(),V("div",ve,[t(A,{class:"points-card"},{header:s(()=>[...e[8]||(e[8]=[c("div",{class:"card-header"},[c("h3",null,"添加积分")],-1)])]),default:s(()=>[c("div",_e,[t(te,{model:r,rules:H,ref_key:"addFormRef",ref:E,"label-width":"100px",inline:""},{default:s(()=>[t(g,{label:"选择班级",prop:"classId"},{default:s(()=>[t(n,{modelValue:r.classId,"onUpdate:modelValue":e[0]||(e[0]=a=>r.classId=a),placeholder:"请选择班级",onChange:K,loading:$.value},{default:s(()=>[(m(!0),V(L,null,S(y.value,a=>(m(),C(l,{key:a.id,label:a.name,value:a.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","loading"])]),_:1}),t(g,{label:"选择学生",prop:"studentId"},{default:s(()=>[t(n,{modelValue:r.studentId,"onUpdate:modelValue":e[1]||(e[1]=a=>r.studentId=a),placeholder:"请选择学生",loading:q.value},{default:s(()=>[(m(!0),V(L,null,S(w.value,a=>(m(),C(l,{key:a.id,label:a.name,value:a.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","loading"])]),_:1}),t(g,{label:"积分",prop:"points"},{default:s(()=>[t(ee,{modelValue:r.points,"onUpdate:modelValue":e[2]||(e[2]=a=>r.points=a),min:-100,max:100,placeholder:"积分值"},null,8,["modelValue"])]),_:1}),t(g,{label:"原因",prop:"reason"},{default:s(()=>[t(ae,{modelValue:r.reason,"onUpdate:modelValue":e[3]||(e[3]=a=>r.reason=a),placeholder:"积分原因",style:{width:"200px"}},null,8,["modelValue"])]),_:1}),t(g,null,{default:s(()=>[t(I,{type:"primary",onClick:O,loading:N.value},{default:s(()=>[...e[9]||(e[9]=[b("添加积分",-1)])]),_:1},8,["loading"])]),_:1})]),_:1},8,["model"])])]),_:1}),t(A,{class:"points-card"},{header:s(()=>[c("div",be,[e[11]||(e[11]=c("h3",null,"班级积分排行榜",-1)),c("div",null,[t(n,{modelValue:h.value,"onUpdate:modelValue":e[4]||(e[4]=a=>h.value=a),placeholder:"选择班级",onChange:R,style:{"margin-right":"10px"}},{default:s(()=>[(m(!0),V(L,null,S(y.value,a=>(m(),C(l,{key:a.id,label:a.name,value:a.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),t(I,{onClick:R,loading:x.value},{default:s(()=>[...e[10]||(e[10]=[b("刷新",-1)])]),_:1},8,["loading"])])])]),default:s(()=>[c("div",ye,[G((m(),C(T,{data:P.value,style:{width:"100%"}},{default:s(()=>[t(i,{label:"排名",width:"80"},{default:s(a=>[c("span",{class:re(["rank",Z(a.$index+1)])},F(a.$index+1),3)]),_:1}),t(i,{prop:"studentName",label:"学生姓名",width:"150"}),t(i,{prop:"totalPoints",label:"总积分",width:"120"},{default:s(a=>[t(M,{type:a.row.totalPoints>=0?"success":"danger"},{default:s(()=>[b(F(a.row.totalPoints),1)]),_:2},1032,["type"])]),_:1}),t(i,{prop:"recordCount",label:"积分记录数",width:"120"}),t(i,{label:"操作"},{default:s(a=>[t(I,{size:"small",onClick:se=>Q(a.row)},{default:s(()=>[...e[12]||(e[12]=[b("查看详情",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])),[[j,x.value]])])]),_:1}),t(A,{class:"points-card"},{header:s(()=>[c("div",we,[e[14]||(e[14]=c("h3",null,"积分记录",-1)),c("div",null,[t(n,{modelValue:B.classId,"onUpdate:modelValue":e[5]||(e[5]=a=>B.classId=a),placeholder:"选择班级",onChange:_,style:{"margin-right":"10px"}},{default:s(()=>[t(l,{label:"全部班级",value:""}),(m(!0),V(L,null,S(y.value,a=>(m(),C(l,{key:a.id,label:a.name,value:a.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),t(I,{onClick:_,loading:k.value},{default:s(()=>[...e[13]||(e[13]=[b("刷新",-1)])]),_:1},8,["loading"])])])]),default:s(()=>[c("div",he,[G((m(),C(T,{data:z.value,style:{width:"100%"}},{default:s(()=>[t(i,{prop:"studentName",label:"学生姓名",width:"120"}),t(i,{prop:"className",label:"班级",width:"120"}),t(i,{prop:"points",label:"积分",width:"100"},{default:s(a=>[t(M,{type:a.row.points>=0?"success":"danger"},{default:s(()=>[b(F(a.row.points>0?"+":"")+F(a.row.points),1)]),_:2},1032,["type"])]),_:1}),t(i,{prop:"reason",label:"原因","show-overflow-tooltip":""}),t(i,{prop:"awardedBy.name",label:"操作人",width:"120"}),t(i,{prop:"createdAt",label:"时间",width:"180"}),t(i,{label:"操作",width:"100"},{default:s(a=>[t(I,{size:"small",type:"danger",onClick:se=>W(a.row)},{default:s(()=>[...e[15]||(e[15]=[b("删除",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])),[[j,k.value]]),t(le,{"current-page":d.page,"onUpdate:currentPage":e[6]||(e[6]=a=>d.page=a),"page-size":d.limit,"onUpdate:pageSize":e[7]||(e[7]=a=>d.limit=a),"page-sizes":[10,20,50,100],total:d.total,layout:"total, sizes, prev, pager, next, jumper",onSizeChange:X,onCurrentChange:Y,style:{"margin-top":"20px","text-align":"right"}},null,8,["current-page","page-size","total"])])]),_:1})])}}},Pe=pe(Ce,[["__scopeId","data-v-49d3ed2b"]]);export{Pe as default};
