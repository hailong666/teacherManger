import{b as se,c as ne,r,o as oe,d,x as re,e as v,f as w,g as a,w as s,m as N,l as ue,y as i,h as o,j as de,H as ie,i as C,t as b,F as H,z as j,A as ce,E as q}from"./main-2e31a8b5.js";import{g as me,a as ve,c as _e,r as pe,b as fe}from"./randomCall-ab3a2a94.js";import{_ as ge}from"./_plugin-vue_export-helper-c27b6911.js";const he={class:"random-call-container"},ye={class:"card-header"},we={class:"call-settings"},Ce={class:"card-header"},be={class:"call-result"},xe={key:0,class:"rolling-display"},Ne={class:"rolling-name"},Ve={key:1,class:"result-list"},ke={class:"student-card"},Se={class:"student-avatar"},Ie={class:"student-info"},ze={class:"card-header"},Re={class:"header-actions"},Be={__name:"RandomCall",setup(Me){const G=se();ne(()=>{var l;return(l=G.user)==null?void 0:l.role});const I=r(!1),z=r(!1),p=r(!1),R=r(!1),V=r([]),k=r([]),f=r([]),S=r([]),B=r(""),g=r(""),M=r(1),$=r(!0),T=r(""),U=r(1),D=r(10),F=r(0),J=async()=>{try{const l=await me();V.value=l.classes||[]}catch(l){i.error("加载班级列表失败"),console.error("加载班级列表失败:",l)}},h=async()=>{var l;try{I.value=!0;const e={page:U.value,limit:D.value,classId:T.value||void 0},n=await ve(e);k.value=n.calls||[],F.value=((l=n.pagination)==null?void 0:l.total)||0}catch(e){i.error("加载点名历史失败"),console.error("加载点名历史失败:",e)}finally{I.value=!1}},K=async l=>{try{const e=await fe(l);S.value=e.students||[]}catch(e){i.error("加载学生列表失败"),console.error("加载学生列表失败:",e),S.value=[]}},O=async()=>{if(!g.value){i.warning("请先选择班级");return}try{if(await K(g.value),S.value.length===0){i.warning("该班级没有学生");return}let l=[...S.value];if($.value&&k.value.length>0){const u=new Set;k.value.forEach(m=>{m.students&&m.students.forEach(E=>{u.add(E.id)})}),l=l.filter(m=>!u.has(m.id))}if(l.length===0){i.warning("没有可点名的学生");return}p.value=!0,f.value=[];const e=2e3,n=100,c=e/n;let _=0;const y=setInterval(()=>{const u=Math.floor(Math.random()*l.length);B.value=l[u].name,_++,_>=c&&(clearInterval(y),Q(l))},n)}catch{i.error("点名失败"),p.value=!1}},Q=l=>{const e=Math.min(M.value,l.length),n=[],c=new Set,_=V.value.find(u=>u.id===g.value),y=_?_.name:"未知班级";for(;n.length<e;){const u=Math.floor(Math.random()*l.length);if(!c.has(u)){c.add(u);const m=l[u];n.push({...m,className:y})}}f.value=n,p.value=!1,B.value="",i.success(`成功点名 ${n.length} 位学生`)},W=async()=>{var l,e;if(f.value.length===0){i.warning("没有点名结果可保存");return}try{z.value=!0;const n={classId:g.value,studentIds:f.value.map(c=>c.id),callType:"random"};await _e(n),i.success("点名记录保存成功"),h(),f.value=[]}catch(n){console.error("保存点名记录失败:",n),i.error(`保存点名记录失败: ${((e=(l=n.response)==null?void 0:l.data)==null?void 0:e.message)||n.message||"未知错误"}`)}finally{z.value=!1}},X=l=>{const e=l.studentNames||(l.students?l.students.map(n=>n.name).join("、"):"无");q.alert(`班级：${l.className}
被点名学生：${e}
点名教师：${l.teacherName}
点名时间：${l.createdAt}`,"点名详情",{confirmButtonText:"确定"})},Y=async()=>{var l,e;try{await q.confirm("确定要重置所有点名状态吗？重置后所有学生都可以重新被点名。","确认重置",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),R.value=!0,await pe(),i.success("点名状态重置成功"),h()}catch(n){n!=="cancel"&&(console.error("重置点名状态失败:",n),i.error(`重置点名状态失败: ${((e=(l=n.response)==null?void 0:l.data)==null?void 0:e.message)||n.message||"未知错误"}`))}finally{R.value=!1}};return oe(()=>{J(),h()}),(l,e)=>{const n=d("el-icon"),c=d("el-button"),_=d("el-option"),y=d("el-select"),u=d("el-form-item"),m=d("el-col"),E=d("el-input-number"),Z=d("el-switch"),P=d("el-row"),A=d("el-card"),ee=d("el-avatar"),x=d("el-table-column"),le=d("el-table"),ae=d("el-pagination"),te=re("loading");return v(),w("div",he,[a(A,{class:"random-call-card"},{header:s(()=>[o("div",ye,[e[6]||(e[6]=o("h3",null,"随机点名设置",-1)),a(c,{type:"primary",onClick:O,disabled:!g.value||p.value,loading:p.value},{default:s(()=>[a(n,null,{default:s(()=>[a(de(ie))]),_:1}),C(" "+b(p.value?"点名中...":"开始点名"),1)]),_:1},8,["disabled","loading"])])]),default:s(()=>[o("div",we,[a(P,{gutter:20},{default:s(()=>[a(m,{span:8},{default:s(()=>[a(u,{label:"选择班级"},{default:s(()=>[a(y,{modelValue:g.value,"onUpdate:modelValue":e[0]||(e[0]=t=>g.value=t),placeholder:"请选择班级",style:{width:"100%"}},{default:s(()=>[(v(!0),w(H,null,j(V.value,t=>(v(),N(_,{key:t.id,label:t.name,value:t.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})]),_:1}),a(m,{span:8},{default:s(()=>[a(u,{label:"点名人数"},{default:s(()=>[a(E,{modelValue:M.value,"onUpdate:modelValue":e[1]||(e[1]=t=>M.value=t),min:1,max:10,placeholder:"点名人数",style:{width:"100%"}},null,8,["modelValue"])]),_:1})]),_:1}),a(m,{span:8},{default:s(()=>[a(u,{label:"排除已点名"},{default:s(()=>[a(Z,{modelValue:$.value,"onUpdate:modelValue":e[2]||(e[2]=t=>$.value=t),"active-text":"是","inactive-text":"否"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1})])]),_:1}),f.value.length>0?(v(),N(A,{key:0,class:"random-call-card"},{header:s(()=>[o("div",Ce,[e[8]||(e[8]=o("h3",null,"点名结果",-1)),a(c,{onClick:W,loading:z.value},{default:s(()=>[...e[7]||(e[7]=[C("保存记录",-1)])]),_:1},8,["loading"])])]),default:s(()=>[o("div",be,[p.value?(v(),w("div",xe,[o("div",Ne,b(B.value),1),e[9]||(e[9]=o("div",{class:"rolling-text"},"正在随机选择...",-1))])):(v(),w("div",Ve,[a(P,{gutter:20},{default:s(()=>[(v(!0),w(H,null,j(f.value,(t,L)=>(v(),N(m,{span:8,key:L},{default:s(()=>[o("div",ke,[o("div",Se,[a(ee,{size:60},{default:s(()=>[C(b(t.name.charAt(0)),1)]),_:2},1024)]),o("div",Ie,[o("h4",null,b(t.name),1),o("p",null,"学号: "+b(t.studentNumber),1),o("p",null,"班级: "+b(t.className),1)])])]),_:2},1024))),128))]),_:1})]))])]),_:1})):ue("",!0),a(A,{class:"random-call-card"},{header:s(()=>[o("div",ze,[e[12]||(e[12]=o("h3",null,"点名历史",-1)),o("div",Re,[a(y,{modelValue:T.value,"onUpdate:modelValue":e[3]||(e[3]=t=>T.value=t),placeholder:"筛选班级",style:{width:"120px","margin-right":"10px"}},{default:s(()=>[a(_,{label:"全部班级",value:""}),(v(!0),w(H,null,j(V.value,t=>(v(),N(_,{key:t.id,label:t.name,value:t.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),a(c,{type:"warning",onClick:Y,loading:R.value},{default:s(()=>[...e[10]||(e[10]=[C("重置点名状态",-1)])]),_:1},8,["loading"]),a(c,{onClick:h},{default:s(()=>[...e[11]||(e[11]=[C("刷新",-1)])]),_:1})])])]),default:s(()=>[ce((v(),N(le,{data:k.value,style:{width:"100%"}},{default:s(()=>[a(x,{prop:"className",label:"班级",width:"120"}),a(x,{prop:"studentNames",label:"被点名学生","min-width":"200","show-overflow-tooltip":""}),a(x,{prop:"teacherName",label:"点名教师",width:"120"}),a(x,{prop:"createdAt",label:"点名时间",width:"180"}),a(x,{label:"操作",width:"100"},{default:s(({row:t})=>[a(c,{size:"small",onClick:L=>X(t)},{default:s(()=>[...e[13]||(e[13]=[C("查看",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])),[[te,I.value]]),a(ae,{"current-page":U.value,"onUpdate:currentPage":e[4]||(e[4]=t=>U.value=t),"page-size":D.value,"onUpdate:pageSize":e[5]||(e[5]=t=>D.value=t),total:F.value,"page-sizes":[10,20,50],layout:"total, sizes, prev, pager, next, jumper",onSizeChange:h,onCurrentChange:h,style:{"margin-top":"20px","text-align":"right"}},null,8,["current-page","page-size","total"])]),_:1})])}}},De=ge(Be,[["__scopeId","data-v-5c02626b"]]);export{De as default};
