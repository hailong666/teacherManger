import{b as ae,r as _,v as se,c as S,o as ne,d as y,e as d,f as c,h as a,t as r,g as i,w as o,l as $,j as oe,U as le,y as l,i as w,F as M,z as P,m as re}from"./main-34d96914.js";import{_ as ie}from"./_plugin-vue_export-helper-c27b6911.js";const de={class:"whiteboard-attendance"},ce={class:"header-info"},ue={class:"class-info"},ve={class:"attendance-stats"},he={class:"whiteboard-container"},me={class:"whiteboard-header"},pe={class:"whiteboard-controls"},_e={class:"canvas-container"},ge={key:0,class:"canvas-placeholder"},fe={key:0,class:"manual-attendance"},ye={class:"manual-form"},we={key:0,style:{color:"#67c23a","margin-left":"10px"}},ke={class:"attendance-stats-section"},be={class:"stats-summary"},Ie={class:"stat-item"},Se={class:"stat-value"},Ce={class:"stat-item"},Te={class:"stat-value present"},xe={class:"stat-item"},De={class:"stat-value absent"},$e={class:"stat-item"},je={class:"stat-value"},Ne={class:"attendance-list"},Ae={class:"list-header"},Be={key:0,class:"empty-state"},ze={key:1,class:"student-grid"},Oe={class:"student-name"},Ve={class:"attendance-time"},Me={class:"attendance-method"},Pe={key:1,class:"student-list"},Re={class:"student-grid"},We={class:"student-name"},Je={class:"student-info"},Le={key:2,class:"all-attended"},Ue={__name:"WhiteboardAttendance",setup(Ee){const j=ae(),C=_(!1),T=_(!1),N=_(!1);_("attended");const k=_(""),h=se({id:null,name:"",teacherId:null}),m=_([]),g=_([]),b=_(null);let v=null,A=0,B=0;const I=S(()=>g.value.filter(t=>t.status==="present").length),z=S(()=>m.value.length-I.value),O=S(()=>g.value.filter(t=>t.status==="present").map(t=>t.studentId)),R=S(()=>m.value.filter(t=>!O.value.includes(t.id))),q=S(()=>m.value.length===0?0:Math.round(I.value/m.value.length*100));S(()=>g.value.map(t=>({id:t.id,studentName:t.studentName,attendanceTime:new Date(t.attendanceTime).toLocaleString(),method:t.method})));const F=()=>{le(()=>{const t=b.value;t&&(v=t.getContext("2d"),t.width=t.offsetWidth,t.height=t.offsetHeight,v.strokeStyle="#2c3e50",v.lineWidth=3,v.lineCap="round",v.lineJoin="round")})},W=t=>{const s=b.value.getBoundingClientRect();return t.touches?{x:t.touches[0].clientX-s.left,y:t.touches[0].clientY-s.top}:{x:t.clientX-s.left,y:t.clientY-s.top}},J=t=>{t.preventDefault(),N.value=!0;const e=W(t);A=e.x,B=e.y},L=t=>{if(!N.value)return;t.preventDefault();const e=W(t);v.beginPath(),v.moveTo(A,B),v.lineTo(e.x,e.y),v.stroke(),A=e.x,B=e.y,T.value=!0},U=t=>{t.preventDefault(),N.value=!1},E=()=>{v&&(v.clearRect(0,0,b.value.width,b.value.height),T.value=!1)},H=async()=>{var t,e;if(!T.value){l.warning("请先在白板上写下您的姓名");return}try{const p=b.value.toDataURL("image/png"),u={classId:h.id,method:"signature",signatureData:p,notes:"希沃白板手写签到"};((e=(t=j.userInfo)==null?void 0:t.role)==null?void 0:e.name)==="student"&&(u.studentId=j.userInfo.id);const f=await fetch("/api/attendance/create",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("teacher-manager-token")}`},body:JSON.stringify(u)}),V=await f.json();f.ok?(l.success("签到成功！"),E(),await x()):l.error(V.message||"签到失败")}catch(s){console.error("签到失败:",s),l.error("签到失败，请重试")}},G=async()=>{if(!k.value){l.warning("请选择学生");return}try{const t=await fetch("/api/attendance/create",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("teacher-manager-token")}`},body:JSON.stringify({classId:h.id,studentId:k.value,method:"manual",notes:"教师手动签到"})}),e=await t.json();t.ok?(l.success("手动签到成功！"),k.value="",await x()):l.error(e.message||"手动签到失败")}catch(t){console.error("手动签到失败:",t),l.error("手动签到失败，请重试")}},K=async()=>{try{C.value=!0;const t=await fetch("/api/classes",{headers:{Authorization:`Bearer ${localStorage.getItem("teacher-manager-token")}`}});if(t.ok){const e=await t.json();if(console.log("获取到的班级数据:",e),e&&e.classes&&e.classes.length>0){const s=e.classes[0];h.id=s.id,h.name=s.name,h.teacherId=s.teacherId,console.log("设置班级信息:",h),await Q(s.id)}else console.warn("没有找到班级数据:",e),l.warning("没有找到可用的班级")}else{const e=await t.json().catch(()=>({}));console.error("获取班级信息失败:",t.status,e),l.error(`获取班级信息失败: ${e.message||t.statusText}`)}}catch(t){console.error("获取班级信息失败:",t),l.error("获取班级信息失败，请检查网络连接")}finally{C.value=!1}},Q=async t=>{try{const e=await fetch(`/api/classes/${t}/students`,{headers:{Authorization:`Bearer ${localStorage.getItem("teacher-manager-token")}`}});if(e.ok){const s=await e.json();console.log("获取到的班级学生数据:",s),m.value=s.students||[]}else{const s=await e.json().catch(()=>({}));console.error("获取班级学生失败:",e.status,s),l.error(`获取班级学生失败: ${s.message||e.statusText}`),m.value=[]}}catch(e){console.error("获取班级学生失败:",e),l.error("获取班级学生失败"),m.value=[]}},x=async()=>{if(h.id)try{C.value=!0;const t=new Date().toISOString().split("T")[0],e=await fetch(`/api/attendance?classId=${h.id}&date=${t}`,{headers:{Authorization:`Bearer ${localStorage.getItem("teacher-manager-token")}`}});if(e.ok){const s=await e.json();console.log("获取到的签到记录数据:",s);const p=s.attendances||[];g.value=p.map(u=>{var f;return{id:u.id,studentId:u.studentId,studentName:u.studentName||((f=u.student)==null?void 0:f.name),attendanceTime:u.attendanceTime||u.class_time,method:u.method,status:"present"}})}else{const s=await e.json().catch(()=>({}));console.error("获取签到列表失败:",e.status,s),l.error(`获取签到记录失败: ${s.message||e.statusText}`),g.value=[]}}catch(t){console.error("获取签到记录失败:",t),l.error("获取签到记录失败"),g.value=[]}finally{C.value=!1}},Z=async t=>{try{const e=await fetch("/api/attendance/create",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("teacher-manager-token")}`},body:JSON.stringify({classId:h.id,studentId:t.id,method:"manual",notes:"教师快速签到"})}),s=await e.json();e.ok?(l.success(`${t.name} 签到成功！`),await x()):l.error(s.message||"快速签到失败")}catch(e){console.error("快速签到失败:",e),l.error("快速签到失败，请重试")}},ee=t=>t?new Date(t).toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit",second:"2-digit"}):"";return ne(async()=>{await K(),await x(),F()}),(t,e)=>{var X,Y;const s=y("el-tag"),p=y("el-button"),u=y("el-button-group"),f=y("el-option"),V=y("el-select"),D=y("el-card"),te=y("el-result");return d(),c("div",de,[a("div",ce,[a("div",ue,[a("h2",null,r(h.name||"班级签到"),1),e[1]||(e[1]=a("p",null,"请在下方白板上写下您的姓名进行签到",-1))]),a("div",ve,[i(s,{type:"success",size:"large"},{default:o(()=>[w("已签到: "+r(I.value)+"人",1)]),_:1}),i(s,{type:"warning",size:"large",style:{"margin-left":"10px"}},{default:o(()=>[w("未签到: "+r(z.value)+"人",1)]),_:1})])]),a("div",he,[a("div",me,[e[4]||(e[4]=a("h3",null,"签到白板",-1)),a("div",pe,[i(u,null,{default:o(()=>[i(p,{onClick:E,type:"warning"},{default:o(()=>[...e[2]||(e[2]=[w("清空画板",-1)])]),_:1}),i(p,{onClick:H,type:"primary",disabled:!T.value},{default:o(()=>[...e[3]||(e[3]=[w("提交签到",-1)])]),_:1},8,["disabled"])]),_:1})])]),a("div",_e,[a("canvas",{ref_key:"signatureCanvas",ref:b,onMousedown:J,onMousemove:L,onMouseup:U,onTouchstart:J,onTouchmove:L,onTouchend:U,class:"signature-canvas"},null,544),T.value?$("",!0):(d(),c("div",ge,[...e[5]||(e[5]=[a("p",null,"请在此处写下您的姓名",-1)])]))])]),((Y=(X=oe(j).userInfo)==null?void 0:X.role)==null?void 0:Y.name)==="teacher"?(d(),c("div",fe,[i(D,null,{header:o(()=>[...e[6]||(e[6]=[a("h3",null,"手动添加签到",-1)])]),default:o(()=>[a("div",ye,[i(V,{modelValue:k.value,"onUpdate:modelValue":e[0]||(e[0]=n=>k.value=n),placeholder:"选择学生",style:{width:"200px","margin-right":"10px"},filterable:""},{default:o(()=>[(d(!0),c(M,null,P(m.value,n=>(d(),re(f,{key:n.id,label:n.name,value:n.id,disabled:O.value.includes(n.id)},{default:o(()=>[a("span",null,r(n.name),1),O.value.includes(n.id)?(d(),c("span",we,"已签到")):$("",!0)]),_:2},1032,["label","value","disabled"]))),128))]),_:1},8,["modelValue"]),i(p,{onClick:G,type:"success",disabled:!k.value},{default:o(()=>[...e[7]||(e[7]=[w("手动签到",-1)])]),_:1},8,["disabled"])])]),_:1})])):$("",!0),a("div",ke,[i(D,null,{header:o(()=>[...e[8]||(e[8]=[a("h3",null,"签到统计",-1)])]),default:o(()=>[a("div",be,[a("div",Ie,[e[9]||(e[9]=a("span",{class:"stat-label"},"总人数:",-1)),a("span",Se,r(m.value.length),1)]),a("div",Ce,[e[10]||(e[10]=a("span",{class:"stat-label"},"已签到:",-1)),a("span",Te,r(I.value),1)]),a("div",xe,[e[11]||(e[11]=a("span",{class:"stat-label"},"未签到:",-1)),a("span",De,r(z.value),1)]),a("div",$e,[e[12]||(e[12]=a("span",{class:"stat-label"},"签到率:",-1)),a("span",je,r(q.value)+"%",1)])])]),_:1})]),a("div",Ne,[i(D,null,{header:o(()=>[a("div",Ae,[a("h3",null,"已签到学生 ("+r(I.value)+"人)",1),i(p,{onClick:x,loading:C.value},{default:o(()=>[...e[13]||(e[13]=[w("刷新",-1)])]),_:1},8,["loading"])])]),default:o(()=>[I.value===0?(d(),c("div",Be,[...e[14]||(e[14]=[a("p",null,"暂无签到记录",-1)])])):(d(),c("div",ze,[(d(!0),c(M,null,P(g.value.filter(n=>n.status==="present"),n=>(d(),c("div",{key:n.id,class:"student-card attended"},[a("div",Oe,r(n.studentName),1),a("div",Ve,r(ee(n.attendanceTime)),1),a("div",Me,r(n.method==="signature"?"手写签到":"手动签到"),1)]))),128))]))]),_:1})]),R.value.length>0?(d(),c("div",Pe,[i(D,null,{header:o(()=>[a("h3",null,"未签到学生 ("+r(z.value)+"人)",1)]),default:o(()=>[a("div",Re,[(d(!0),c(M,null,P(R.value,n=>(d(),c("div",{key:n.id,class:"student-card unattended"},[a("div",We,r(n.name),1),a("div",Je,r(n.username||n.studentId||n.id),1),i(p,{size:"small",type:"primary",onClick:Xe=>Z(n),style:{"margin-top":"8px"}},{default:o(()=>[...e[15]||(e[15]=[w(" 快速签到 ",-1)])]),_:1},8,["onClick"])]))),128))])]),_:1})])):m.value.length>0?(d(),c("div",Le,[i(D,null,{default:o(()=>[i(te,{icon:"success",title:"全部学生已签到","sub-title":"今日所有学生都已完成签到"})]),_:1})])):$("",!0)])}}},Fe=ie(Ue,[["__scopeId","data-v-b9a985a1"]]);export{Fe as default};
