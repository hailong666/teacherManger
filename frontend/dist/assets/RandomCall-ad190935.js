import{b as le,c as ae,r,o as te,d,x as se,e as m,f as y,g as a,w as s,m as x,l as ne,y as v,h as o,j as oe,J as re,i as N,t as C,F as A,z as j,A as ue,E as de}from"./main-34d96914.js";import{g as ie,a as ce,c as me,b as ve}from"./randomCall-ef5da8f1.js";import{_ as _e}from"./_plugin-vue_export-helper-c27b6911.js";const pe={class:"random-call-container"},fe={class:"card-header"},ge={class:"call-settings"},he={class:"card-header"},ye={class:"call-result"},Ce={key:0,class:"rolling-display"},we={class:"rolling-name"},be={key:1,class:"result-list"},xe={class:"student-card"},Ne={class:"student-avatar"},Ve={class:"student-info"},ke={class:"card-header"},Ie={class:"header-actions"},Se={__name:"RandomCall",setup(ze){const J=le();ae(()=>{var l;return(l=J.user)==null?void 0:l.role});const S=r(!1),z=r(!1),p=r(!1),V=r([]),k=r([]),f=r([]),I=r([]),R=r(""),g=r(""),M=r(1),B=r(!0),U=r(""),$=r(1),D=r(10),H=r(0),L=async()=>{try{const l=await ie();V.value=l.classes||[]}catch(l){v.error("加载班级列表失败"),console.error("加载班级列表失败:",l)}},w=async()=>{var l;try{S.value=!0;const e={page:$.value,limit:D.value,classId:U.value||void 0},n=await ce(e);k.value=n.calls||[],H.value=((l=n.pagination)==null?void 0:l.total)||0}catch(e){v.error("加载点名历史失败"),console.error("加载点名历史失败:",e)}finally{S.value=!1}},q=async l=>{try{const e=await ve(l);I.value=e.students||[]}catch(e){v.error("加载学生列表失败"),console.error("加载学生列表失败:",e),I.value=[]}},G=async()=>{if(!g.value){v.warning("请先选择班级");return}try{if(await q(g.value),I.value.length===0){v.warning("该班级没有学生");return}let l=[...I.value];if(B.value&&k.value.length>0){const u=new Set;k.value.forEach(c=>{c.students&&c.students.forEach(E=>{u.add(E.id)})}),l=l.filter(c=>!u.has(c.id))}if(l.length===0){v.warning("没有可点名的学生");return}p.value=!0,f.value=[];const e=2e3,n=100,i=e/n;let _=0;const h=setInterval(()=>{const u=Math.floor(Math.random()*l.length);R.value=l[u].name,_++,_>=i&&(clearInterval(h),K(l))},n)}catch{v.error("点名失败"),p.value=!1}},K=l=>{const e=Math.min(M.value,l.length),n=[],i=new Set,_=V.value.find(u=>u.id===g.value),h=_?_.name:"未知班级";for(;n.length<e;){const u=Math.floor(Math.random()*l.length);if(!i.has(u)){i.add(u);const c=l[u];n.push({...c,className:h})}}f.value=n,p.value=!1,R.value="",v.success(`成功点名 ${n.length} 位学生`)},O=async()=>{var l,e;if(f.value.length===0){v.warning("没有点名结果可保存");return}try{z.value=!0;const n={classId:g.value,studentIds:f.value.map(i=>i.id),callType:"random"};await me(n),v.success("点名记录保存成功"),w(),f.value=[]}catch(n){console.error("保存点名记录失败:",n),v.error(`保存点名记录失败: ${((e=(l=n.response)==null?void 0:l.data)==null?void 0:e.message)||n.message||"未知错误"}`)}finally{z.value=!1}},Q=l=>{const e=l.studentNames||(l.students?l.students.map(n=>n.name).join("、"):"无");de.alert(`班级：${l.className}
被点名学生：${e}
点名教师：${l.teacherName}
点名时间：${l.createdAt}`,"点名详情",{confirmButtonText:"确定"})};return te(()=>{L(),w()}),(l,e)=>{const n=d("el-icon"),i=d("el-button"),_=d("el-option"),h=d("el-select"),u=d("el-form-item"),c=d("el-col"),E=d("el-input-number"),W=d("el-switch"),F=d("el-row"),T=d("el-card"),X=d("el-avatar"),b=d("el-table-column"),Y=d("el-table"),Z=d("el-pagination"),ee=se("loading");return m(),y("div",pe,[a(T,{class:"random-call-card"},{header:s(()=>[o("div",fe,[e[6]||(e[6]=o("h3",null,"随机点名设置",-1)),a(i,{type:"primary",onClick:G,disabled:!g.value||p.value,loading:p.value},{default:s(()=>[a(n,null,{default:s(()=>[a(oe(re))]),_:1}),N(" "+C(p.value?"点名中...":"开始点名"),1)]),_:1},8,["disabled","loading"])])]),default:s(()=>[o("div",ge,[a(F,{gutter:20},{default:s(()=>[a(c,{span:8},{default:s(()=>[a(u,{label:"选择班级"},{default:s(()=>[a(h,{modelValue:g.value,"onUpdate:modelValue":e[0]||(e[0]=t=>g.value=t),placeholder:"请选择班级",style:{width:"100%"}},{default:s(()=>[(m(!0),y(A,null,j(V.value,t=>(m(),x(_,{key:t.id,label:t.name,value:t.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})]),_:1}),a(c,{span:8},{default:s(()=>[a(u,{label:"点名人数"},{default:s(()=>[a(E,{modelValue:M.value,"onUpdate:modelValue":e[1]||(e[1]=t=>M.value=t),min:1,max:10,placeholder:"点名人数",style:{width:"100%"}},null,8,["modelValue"])]),_:1})]),_:1}),a(c,{span:8},{default:s(()=>[a(u,{label:"排除已点名"},{default:s(()=>[a(W,{modelValue:B.value,"onUpdate:modelValue":e[2]||(e[2]=t=>B.value=t),"active-text":"是","inactive-text":"否"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1})])]),_:1}),f.value.length>0?(m(),x(T,{key:0,class:"random-call-card"},{header:s(()=>[o("div",he,[e[8]||(e[8]=o("h3",null,"点名结果",-1)),a(i,{onClick:O,loading:z.value},{default:s(()=>[...e[7]||(e[7]=[N("保存记录",-1)])]),_:1},8,["loading"])])]),default:s(()=>[o("div",ye,[p.value?(m(),y("div",Ce,[o("div",we,C(R.value),1),e[9]||(e[9]=o("div",{class:"rolling-text"},"正在随机选择...",-1))])):(m(),y("div",be,[a(F,{gutter:20},{default:s(()=>[(m(!0),y(A,null,j(f.value,(t,P)=>(m(),x(c,{span:8,key:P},{default:s(()=>[o("div",xe,[o("div",Ne,[a(X,{size:60},{default:s(()=>[N(C(t.name.charAt(0)),1)]),_:2},1024)]),o("div",Ve,[o("h4",null,C(t.name),1),o("p",null,"学号: "+C(t.studentNumber),1),o("p",null,"班级: "+C(t.className),1)])])]),_:2},1024))),128))]),_:1})]))])]),_:1})):ne("",!0),a(T,{class:"random-call-card"},{header:s(()=>[o("div",ke,[e[11]||(e[11]=o("h3",null,"点名历史",-1)),o("div",Ie,[a(h,{modelValue:U.value,"onUpdate:modelValue":e[3]||(e[3]=t=>U.value=t),placeholder:"筛选班级",style:{width:"120px","margin-right":"10px"}},{default:s(()=>[a(_,{label:"全部班级",value:""}),(m(!0),y(A,null,j(V.value,t=>(m(),x(_,{key:t.id,label:t.name,value:t.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),a(i,{onClick:w},{default:s(()=>[...e[10]||(e[10]=[N("刷新",-1)])]),_:1})])])]),default:s(()=>[ue((m(),x(Y,{data:k.value,style:{width:"100%"}},{default:s(()=>[a(b,{prop:"className",label:"班级",width:"120"}),a(b,{prop:"studentNames",label:"被点名学生","min-width":"200","show-overflow-tooltip":""}),a(b,{prop:"teacherName",label:"点名教师",width:"120"}),a(b,{prop:"createdAt",label:"点名时间",width:"180"}),a(b,{label:"操作",width:"100"},{default:s(({row:t})=>[a(i,{size:"small",onClick:P=>Q(t)},{default:s(()=>[...e[12]||(e[12]=[N("查看",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])),[[ee,S.value]]),a(Z,{"current-page":$.value,"onUpdate:currentPage":e[4]||(e[4]=t=>$.value=t),"page-size":D.value,"onUpdate:pageSize":e[5]||(e[5]=t=>D.value=t),total:H.value,"page-sizes":[10,20,50],layout:"total, sizes, prev, pager, next, jumper",onSizeChange:w,onCurrentChange:w,style:{"margin-top":"20px","text-align":"right"}},null,8,["current-page","page-size","total"])]),_:1})])}}},Ue=_e(Se,[["__scopeId","data-v-e0712f69"]]);export{Ue as default};
