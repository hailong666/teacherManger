import{r as d,v as Q,o as Ve,d as u,x as xe,e as C,f as z,g as a,w as l,y as i,K as oe,h as f,F as W,z as X,i as r,L as ke,A as Se,m as D,t as x,l as Y,E as ne}from"./main-34d96914.js";import{g as ze,c as Ue,a as M,u as $e,b as Fe,r as Ae,d as Ie}from"./class-f7f45a5e.js";import{_ as Be}from"./_plugin-vue_export-helper-c27b6911.js";const Ne={class:"class-management-container"},Le={class:"create-class-section"},Te={class:"card-header"},De={class:"header-actions"},Me={class:"class-list-section"},Re={class:"dialog-footer"},Ee={key:0},qe={key:0,style:{"margin-top":"20px"}},Ke={class:"students-management"},je={class:"add-students-section"},Oe={key:0,class:"current-students-section"},Pe={__name:"ClassManagement",setup(Ze){const N=d(!1),R=d(!1),E=d(!1),q=d(!1),K=d(!1),j=d(!1),F=d(),O=d(),k=d([]),L=d([]),S=d([]),h=d([]),_=d(null),U=d([]),A=d(""),I=d(!1),P=d(!1),Z=d(!1),m=Q({name:"",description:"",teacherId:""}),y=Q({id:"",name:"",description:"",teacherId:""}),p=Q({page:1,limit:10,total:0}),re={name:[{required:!0,message:"请输入班级名称",trigger:"blur"},{min:2,max:50,message:"班级名称长度在 2 到 50 个字符",trigger:"blur"},{pattern:/^[\u4e00-\u9fa5a-zA-Z0-9\s]+$/,message:"班级名称只能包含中文、英文、数字和空格",trigger:"blur"}],teacherId:[{required:!0,message:"请选择班主任",trigger:"change"}],description:[{max:200,message:"班级描述不能超过200个字符",trigger:"blur"}]},ie={name:[{required:!0,message:"请输入班级名称",trigger:"blur"}],teacherId:[{required:!0,message:"请选择班主任",trigger:"change"}]},V=async()=>{var o,e,n,s;N.value=!0;try{const c={page:p.page,limit:p.limit};(o=A.value)!=null&&o.trim()&&(c.search=A.value.trim());const w=await ze(c);w?(k.value=Array.isArray(w.classes)?w.classes:[],p.total=((e=w.pagination)==null?void 0:e.total)||k.value.length,k.value=k.value.map(v=>{var $;return{...v,studentCount:v.studentCount||0,teacherName:v.teacherName||(($=v.teacher)==null?void 0:$.name)||"未分配",createdAt:v.createdAt?new Date(v.createdAt).toLocaleString():"未知"}}),k.value.length===0&&A.value&&i.info("未找到匹配的班级")):(k.value=[],p.total=0)}catch(c){console.error("获取班级列表失败:",c),i.error(((s=(n=c.response)==null?void 0:n.data)==null?void 0:s.message)||"获取班级列表失败，请稍后重试"),k.value=[],p.total=0}finally{N.value=!1}},de=async()=>{var o,e,n;q.value=!0;try{const s=await oe({role:"teacher",limit:100});L.value=((o=s.data)==null?void 0:o.users)||[]}catch(s){console.error("获取教师列表失败:",s),i.error(((n=(e=s.response)==null?void 0:e.data)==null?void 0:n.message)||"获取教师列表失败，请稍后重试"),L.value=[]}finally{q.value=!1}},ee=async()=>{var o,e,n;K.value=!0;try{const s=await oe({role:"student",limit:1e3});S.value=((o=s.data)==null?void 0:o.users)||[]}catch(s){console.error("获取学生列表失败:",s),i.error(((n=(e=s.response)==null?void 0:e.data)==null?void 0:n.message)||"获取学生列表失败，请稍后重试"),S.value=[]}finally{K.value=!1}},ue=async()=>{F.value&&await F.value.validate(async o=>{var e,n,s;if(o){R.value=!0;try{if(k.value.find($=>$.name===m.name.trim())){i.warning("班级名称已存在，请使用其他名称");return}const w=await Ue({...m,name:m.name.trim(),description:((e=m.description)==null?void 0:e.trim())||""});i.success(`班级「${m.name}」创建成功！`),ae(),await V();const v=document.querySelector(".class-list-section");v&&v.scrollIntoView({behavior:"smooth"})}catch(c){console.error("创建班级失败:",c);const w=((s=(n=c.response)==null?void 0:n.data)==null?void 0:s.message)||"创建班级失败，请检查网络连接后重试";i.error(w)}finally{R.value=!1}}else i.warning("请完善班级信息后再提交")})},ae=()=>{F.value&&F.value.resetFields(),Object.assign(m,{name:"",description:"",teacherId:""})},ce=async o=>{try{const e=await M(o.id);_.value=e.class,h.value=e.class.students||[],P.value=!0}catch{i.error("获取班级详情失败")}},me=o=>{Object.assign(y,{id:o.id,name:o.name,description:o.description,teacherId:o.teacherId}),I.value=!0},pe=async()=>{O.value&&await O.value.validate(async o=>{var e,n;if(o){E.value=!0;try{await $e(y.id,{name:y.name,description:y.description,teacherId:y.teacherId}),i.success("班级更新成功"),I.value=!1,V()}catch(s){i.error(((n=(e=s.response)==null?void 0:e.data)==null?void 0:n.message)||"更新班级失败")}finally{E.value=!1}}})},ve=async o=>{_.value=o,U.value=[];try{const[e]=await Promise.all([M(o.id),ee()]);h.value=e.class.students||[];const n=h.value.map(s=>s.id);S.value=S.value.filter(s=>!n.includes(s.id)),Z.value=!0}catch{i.error("获取班级信息失败")}},ge=async()=>{var o,e;if(U.value.length===0){i.warning("请选择要添加的学生");return}j.value=!0;try{await Fe(_.value.id,U.value),i.success("学生添加成功"),U.value=[];const n=await M(_.value.id);h.value=n.class.students||[];const s=h.value.map(c=>c.id);await ee(),S.value=S.value.filter(c=>!s.includes(c.id)),V()}catch(n){i.error(((e=(o=n.response)==null?void 0:o.data)==null?void 0:e.message)||"添加学生失败")}finally{j.value=!1}},fe=async o=>{var e,n;try{await ne.confirm(`确定要将学生 ${o.name} 从班级中移除吗？`,"确认移除",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),await Ae(_.value.id,o.id),i.success("学生移除成功");const s=await M(_.value.id);h.value=s.class.students||[],S.value.push(o),V()}catch(s){s!=="cancel"&&i.error(((n=(e=s.response)==null?void 0:e.data)==null?void 0:n.message)||"移除学生失败")}},_e=async o=>{var e,n;try{await ne.confirm(`确定要删除班级 ${o.name} 吗？此操作不可恢复！`,"确认删除",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),await Ie(o.id),i.success("班级删除成功"),V()}catch(s){s!=="cancel"&&i.error(((n=(e=s.response)==null?void 0:e.data)==null?void 0:n.message)||"删除班级失败")}},ye=o=>{p.limit=o,p.page=1,V()},we=o=>{p.page=o,V()};return Ve(()=>{V(),de()}),(o,e)=>{const n=u("el-input"),s=u("el-form-item"),c=u("el-col"),w=u("el-option"),v=u("el-select"),$=u("el-row"),b=u("el-button"),te=u("el-form"),le=u("el-card"),G=u("el-text"),g=u("el-table-column"),se=u("el-tag"),H=u("el-table"),be=u("el-pagination"),J=u("el-dialog"),B=u("el-descriptions-item"),Ce=u("el-descriptions"),he=xe("loading");return C(),z("div",Ne,[a(le,{class:"class-card"},{header:l(()=>[...e[14]||(e[14]=[f("div",{class:"card-header"},[f("h3",null,"创建班级")],-1)])]),default:l(()=>[f("div",Le,[a(te,{model:m,rules:re,ref_key:"createFormRef",ref:F,"label-width":"100px"},{default:l(()=>[a($,{gutter:20},{default:l(()=>[a(c,{span:12},{default:l(()=>[a(s,{label:"班级名称",prop:"name"},{default:l(()=>[a(n,{modelValue:m.name,"onUpdate:modelValue":e[0]||(e[0]=t=>m.name=t),placeholder:"请输入班级名称"},null,8,["modelValue"])]),_:1})]),_:1}),a(c,{span:12},{default:l(()=>[a(s,{label:"班主任",prop:"teacherId"},{default:l(()=>[a(v,{modelValue:m.teacherId,"onUpdate:modelValue":e[1]||(e[1]=t=>m.teacherId=t),placeholder:"请选择班主任",style:{width:"100%"},loading:q.value},{default:l(()=>[(C(!0),z(W,null,X(L.value,t=>(C(),D(w,{key:t.id,label:t.name,value:t.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","loading"])]),_:1})]),_:1})]),_:1}),a(s,{label:"班级描述",prop:"description"},{default:l(()=>[a(n,{modelValue:m.description,"onUpdate:modelValue":e[2]||(e[2]=t=>m.description=t),type:"textarea",rows:3,placeholder:"请输入班级描述"},null,8,["modelValue"])]),_:1}),a(s,null,{default:l(()=>[a(b,{type:"primary",onClick:ue,loading:R.value},{default:l(()=>[...e[15]||(e[15]=[r("创建班级",-1)])]),_:1},8,["loading"]),a(b,{onClick:ae},{default:l(()=>[...e[16]||(e[16]=[r("重置",-1)])]),_:1})]),_:1})]),_:1},8,["model"])])]),_:1}),a(le,{class:"class-card"},{header:l(()=>[f("div",Te,[e[18]||(e[18]=f("h3",null,"班级列表",-1)),f("div",De,[a(n,{modelValue:A.value,"onUpdate:modelValue":e[3]||(e[3]=t=>A.value=t),placeholder:"搜索班级名称",style:{width:"200px","margin-right":"10px"},onKeyup:ke(V,["enter"])},null,8,["modelValue"]),a(b,{onClick:V,loading:N.value},{default:l(()=>[...e[17]||(e[17]=[r("刷新",-1)])]),_:1},8,["loading"])])])]),default:l(()=>[f("div",Me,[Se((C(),D(H,{data:k.value,style:{width:"100%"},"empty-text":"暂无班级数据"},{default:l(()=>[a(g,{prop:"name",label:"班级名称",width:"150","show-overflow-tooltip":""},{default:l(t=>[a(G,{class:"class-name",type:"primary"},{default:l(()=>[r(x(t.row.name),1)]),_:2},1024)]),_:1}),a(g,{prop:"description",label:"班级描述","show-overflow-tooltip":"","min-width":"200"},{default:l(t=>[a(G,{class:"class-description"},{default:l(()=>[r(x(t.row.description||"暂无描述"),1)]),_:2},1024)]),_:1}),a(g,{prop:"teacherName",label:"班主任",width:"120"},{default:l(t=>[a(se,{type:t.row.teacherName==="未分配"?"warning":"success",size:"small"},{default:l(()=>[r(x(t.row.teacherName),1)]),_:2},1032,["type"])]),_:1}),a(g,{prop:"studentCount",label:"学生人数",width:"100"},{default:l(t=>[a(se,{type:"info",size:"small"},{default:l(()=>[r(x(t.row.studentCount)+"人",1)]),_:2},1024)]),_:1}),a(g,{prop:"createdAt",label:"创建时间",width:"180"},{default:l(t=>[a(G,{size:"small"},{default:l(()=>[r(x(t.row.createdAt),1)]),_:2},1024)]),_:1}),a(g,{label:"操作",width:"250"},{default:l(t=>[a(b,{size:"small",onClick:T=>ce(t.row)},{default:l(()=>[...e[19]||(e[19]=[r("查看",-1)])]),_:1},8,["onClick"]),a(b,{size:"small",onClick:T=>me(t.row)},{default:l(()=>[...e[20]||(e[20]=[r("编辑",-1)])]),_:1},8,["onClick"]),a(b,{size:"small",onClick:T=>ve(t.row)},{default:l(()=>[...e[21]||(e[21]=[r("管理学生",-1)])]),_:1},8,["onClick"]),a(b,{size:"small",type:"danger",onClick:T=>_e(t.row)},{default:l(()=>[...e[22]||(e[22]=[r("删除",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])),[[he,N.value]]),a(be,{"current-page":p.page,"onUpdate:currentPage":e[4]||(e[4]=t=>p.page=t),"page-size":p.limit,"onUpdate:pageSize":e[5]||(e[5]=t=>p.limit=t),"page-sizes":[10,20,50,100],total:p.total,layout:"total, sizes, prev, pager, next, jumper",onSizeChange:ye,onCurrentChange:we,style:{"margin-top":"20px","text-align":"right"}},null,8,["current-page","page-size","total"])])]),_:1}),a(J,{modelValue:I.value,"onUpdate:modelValue":e[10]||(e[10]=t=>I.value=t),title:"编辑班级",width:"50%"},{footer:l(()=>[f("span",Re,[a(b,{onClick:e[9]||(e[9]=t=>I.value=!1)},{default:l(()=>[...e[23]||(e[23]=[r("取消",-1)])]),_:1}),a(b,{type:"primary",onClick:pe,loading:E.value},{default:l(()=>[...e[24]||(e[24]=[r("确定",-1)])]),_:1},8,["loading"])])]),default:l(()=>[a(te,{model:y,rules:ie,ref_key:"editFormRef",ref:O,"label-width":"100px"},{default:l(()=>[a(s,{label:"班级名称",prop:"name"},{default:l(()=>[a(n,{modelValue:y.name,"onUpdate:modelValue":e[6]||(e[6]=t=>y.name=t),placeholder:"请输入班级名称"},null,8,["modelValue"])]),_:1}),a(s,{label:"班主任",prop:"teacherId"},{default:l(()=>[a(v,{modelValue:y.teacherId,"onUpdate:modelValue":e[7]||(e[7]=t=>y.teacherId=t),placeholder:"请选择班主任",style:{width:"100%"}},{default:l(()=>[(C(!0),z(W,null,X(L.value,t=>(C(),D(w,{key:t.id,label:t.name,value:t.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),a(s,{label:"班级描述",prop:"description"},{default:l(()=>[a(n,{modelValue:y.description,"onUpdate:modelValue":e[8]||(e[8]=t=>y.description=t),type:"textarea",rows:3,placeholder:"请输入班级描述"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),a(J,{modelValue:P.value,"onUpdate:modelValue":e[11]||(e[11]=t=>P.value=t),title:"班级详情",width:"60%"},{default:l(()=>[_.value?(C(),z("div",Ee,[a(Ce,{column:2,border:""},{default:l(()=>[a(B,{label:"班级名称"},{default:l(()=>[r(x(_.value.name),1)]),_:1}),a(B,{label:"班主任"},{default:l(()=>[r(x(_.value.teacherName),1)]),_:1}),a(B,{label:"学生人数"},{default:l(()=>[r(x(_.value.studentCount)+"人",1)]),_:1}),a(B,{label:"创建时间"},{default:l(()=>[r(x(_.value.createdAt),1)]),_:1}),a(B,{label:"班级描述",span:2},{default:l(()=>[r(x(_.value.description||"暂无描述"),1)]),_:1})]),_:1}),h.value.length>0?(C(),z("div",qe,[e[25]||(e[25]=f("h4",null,"班级学生",-1)),a(H,{data:h.value,style:{width:"100%"}},{default:l(()=>[a(g,{prop:"name",label:"姓名",width:"120"}),a(g,{prop:"username",label:"用户名",width:"120"}),a(g,{prop:"email",label:"邮箱"})]),_:1},8,["data"])])):Y("",!0)])):Y("",!0)]),_:1},8,["modelValue"]),a(J,{modelValue:Z.value,"onUpdate:modelValue":e[13]||(e[13]=t=>Z.value=t),title:"管理学生",width:"70%"},{default:l(()=>[f("div",Ke,[f("div",je,[e[27]||(e[27]=f("h4",null,"添加学生到班级",-1)),a(v,{modelValue:U.value,"onUpdate:modelValue":e[12]||(e[12]=t=>U.value=t),multiple:"",placeholder:"选择学生",style:{width:"100%","margin-bottom":"10px"},loading:K.value},{default:l(()=>[(C(!0),z(W,null,X(S.value,t=>(C(),D(w,{key:t.id,label:`${t.name} (${t.username})`,value:t.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","loading"]),a(b,{type:"primary",onClick:ge,loading:j.value},{default:l(()=>[...e[26]||(e[26]=[r("添加学生",-1)])]),_:1},8,["loading"])]),h.value.length>0?(C(),z("div",Oe,[e[29]||(e[29]=f("h4",null,"当前班级学生",-1)),a(H,{data:h.value,style:{width:"100%"}},{default:l(()=>[a(g,{prop:"name",label:"姓名",width:"120"}),a(g,{prop:"username",label:"用户名",width:"120"}),a(g,{prop:"email",label:"邮箱"}),a(g,{label:"操作",width:"100"},{default:l(t=>[a(b,{size:"small",type:"danger",onClick:T=>fe(t.row)},{default:l(()=>[...e[28]||(e[28]=[r("移除",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])])):Y("",!0)])]),_:1},8,["modelValue"])])}}},Qe=Be(Pe,[["__scopeId","data-v-60b7053c"]]);export{Qe as default};
