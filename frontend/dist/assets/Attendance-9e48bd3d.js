import{g as W,a as X,u as Y}from"./attendance-fbbd8396.js";import{g as Z}from"./class-f7f45a5e.js";import{_ as ee}from"./_plugin-vue_export-helper-c27b6911.js";import{r as m,v as z,o as te,d as i,x as ae,e as w,f as N,g as t,w as n,y as _,h as r,F as le,z as se,i as f,t as x,l as ne,A as oe,m as D}from"./main-34d96914.js";const de={class:"attendance-container"},ie={class:"qrcode-section"},re={key:0,class:"qrcode-display"},ue={class:"qrcode-image"},ce=["src"],pe={class:"qrcode-info"},me={class:"session-id"},_e={class:"card-header"},ge={class:"attendance-list"},fe={class:"dialog-footer"},ve={__name:"Attendance",setup(be){const h=m(!1),k=m(!1),I=m(!1),A=m(""),U=m(""),v=m(!1),C=m([]),c=z({classId:"",validMinutes:5}),o=z({id:"",studentName:"",status:"",notes:""}),V=m([]),d=z({page:1,limit:10,total:0}),M=async()=>{var a,e;if(!c.classId){_.warning("请选择班级");return}h.value=!0;try{const l=await X(c.classId);l&&l.qrCode?(A.value=l.qrCode,U.value=l.sessionId,_.success("签到码生成成功")):_.error("生成签到码失败：服务器响应异常")}catch(l){_.error("生成签到码失败："+(((e=(a=l.response)==null?void 0:a.data)==null?void 0:e.message)||l.message))}finally{h.value=!1}},b=async()=>{var a,e,l;k.value=!0;try{const p={page:d.page,limit:d.limit},u=await W(p);u&&u.attendances?(V.value=u.attendances||[],d.total=((a=u.pagination)==null?void 0:a.total)||0):(V.value=[],d.total=0)}catch(p){_.error("获取签到记录失败："+(((l=(e=p.response)==null?void 0:e.data)==null?void 0:l.message)||p.message)),V.value=[],d.total=0}finally{k.value=!1}},T=()=>{b()},B=a=>{o.id=a.id,o.studentName=a.student.name,o.status=a.status,o.notes=a.notes||"",v.value=!0},F=async()=>{var a,e;try{await Y({id:o.id,status:o.status,notes:o.notes}),_.success("更新成功"),v.value=!1,b()}catch(l){_.error("更新失败："+(((e=(a=l.response)==null?void 0:a.data)==null?void 0:e.message)||l.message))}},R=a=>{d.limit=a,d.page=1,b()},E=a=>{d.page=a,b()},Q=a=>a?new Date(a).toLocaleString("zh-CN"):"-",$=a=>({present:"success",late:"warning",absent:"danger"})[a]||"info",j=a=>({present:"已签到",late:"迟到",absent:"缺席"})[a]||"未知",P=async()=>{var a,e;I.value=!0;try{const l=await Z();l&&l.classes?C.value=l.classes:C.value=[]}catch(l){_.error("获取班级列表失败："+(((e=(a=l.response)==null?void 0:a.data)==null?void 0:e.message)||l.message)),C.value=[]}finally{I.value=!1}};return te(()=>{P(),b()}),(a,e)=>{const l=i("el-option"),p=i("el-select"),u=i("el-form-item"),y=i("el-button"),q=i("el-form"),S=i("el-card"),g=i("el-table-column"),G=i("el-tag"),H=i("el-table"),J=i("el-pagination"),L=i("el-input"),K=i("el-dialog"),O=ae("loading");return w(),N("div",de,[t(S,{class:"attendance-card"},{header:n(()=>[...e[9]||(e[9]=[r("div",{class:"card-header"},[r("h3",null,"生成签到码")],-1)])]),default:n(()=>[r("div",ie,[t(q,{model:c,"label-width":"100px"},{default:n(()=>[t(u,{label:"班级"},{default:n(()=>[t(p,{modelValue:c.classId,"onUpdate:modelValue":e[0]||(e[0]=s=>c.classId=s),placeholder:"请选择班级",style:{width:"200px"},loading:I.value},{default:n(()=>[(w(!0),N(le,null,se(C.value,s=>(w(),D(l,{key:s.id,label:s.name,value:s.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","loading"])]),_:1}),t(u,{label:"有效时间"},{default:n(()=>[t(p,{modelValue:c.validMinutes,"onUpdate:modelValue":e[1]||(e[1]=s=>c.validMinutes=s),style:{width:"200px"}},{default:n(()=>[t(l,{label:"5分钟",value:5}),t(l,{label:"10分钟",value:10}),t(l,{label:"15分钟",value:15})]),_:1},8,["modelValue"])]),_:1}),t(u,null,{default:n(()=>[t(y,{type:"primary",onClick:M,loading:h.value},{default:n(()=>[...e[10]||(e[10]=[f("生成签到码",-1)])]),_:1},8,["loading"])]),_:1})]),_:1},8,["model"]),A.value?(w(),N("div",re,[e[11]||(e[11]=r("h4",null,"签到二维码",-1)),r("div",ue,[r("img",{src:A.value,alt:"签到二维码"},null,8,ce)]),r("p",pe,"有效时间："+x(c.validMinutes)+"分钟",1),r("p",me,"会话ID："+x(U.value),1)])):ne("",!0)])]),_:1}),t(S,{class:"attendance-card"},{header:n(()=>[r("div",_e,[e[13]||(e[13]=r("h3",null,"签到记录",-1)),t(y,{onClick:T},{default:n(()=>[...e[12]||(e[12]=[f("刷新",-1)])]),_:1})])]),default:n(()=>[r("div",ge,[oe((w(),D(H,{data:V.value,style:{width:"100%"}},{default:n(()=>[t(g,{prop:"student.name",label:"学生姓名",width:"120"}),t(g,{prop:"student.studentId",label:"学号",width:"120"}),t(g,{prop:"class.name",label:"班级",width:"120"}),t(g,{prop:"checkInTime",label:"签到时间",width:"180"},{default:n(s=>[f(x(Q(s.row.checkInTime)),1)]),_:1}),t(g,{prop:"status",label:"状态",width:"100"},{default:n(s=>[t(G,{type:$(s.row.status)},{default:n(()=>[f(x(j(s.row.status)),1)]),_:2},1032,["type"])]),_:1}),t(g,{prop:"location",label:"签到位置","show-overflow-tooltip":""}),t(g,{label:"操作",width:"120"},{default:n(s=>[t(y,{size:"small",onClick:ye=>B(s.row)},{default:n(()=>[...e[14]||(e[14]=[f("编辑",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])),[[O,k.value]]),t(J,{"current-page":d.page,"onUpdate:currentPage":e[2]||(e[2]=s=>d.page=s),"page-size":d.limit,"onUpdate:pageSize":e[3]||(e[3]=s=>d.limit=s),"page-sizes":[10,20,50,100],total:d.total,layout:"total, sizes, prev, pager, next, jumper",onSizeChange:R,onCurrentChange:E,style:{"margin-top":"20px","text-align":"right"}},null,8,["current-page","page-size","total"])])]),_:1}),t(K,{modelValue:v.value,"onUpdate:modelValue":e[8]||(e[8]=s=>v.value=s),title:"编辑签到记录",width:"500px"},{footer:n(()=>[r("span",fe,[t(y,{onClick:e[7]||(e[7]=s=>v.value=!1)},{default:n(()=>[...e[15]||(e[15]=[f("取消",-1)])]),_:1}),t(y,{type:"primary",onClick:F},{default:n(()=>[...e[16]||(e[16]=[f("确定",-1)])]),_:1})])]),default:n(()=>[t(q,{model:o,"label-width":"100px"},{default:n(()=>[t(u,{label:"学生姓名"},{default:n(()=>[t(L,{modelValue:o.studentName,"onUpdate:modelValue":e[4]||(e[4]=s=>o.studentName=s),disabled:""},null,8,["modelValue"])]),_:1}),t(u,{label:"签到状态"},{default:n(()=>[t(p,{modelValue:o.status,"onUpdate:modelValue":e[5]||(e[5]=s=>o.status=s)},{default:n(()=>[t(l,{label:"已签到",value:"present"}),t(l,{label:"迟到",value:"late"}),t(l,{label:"缺席",value:"absent"})]),_:1},8,["modelValue"])]),_:1}),t(u,{label:"备注"},{default:n(()=>[t(L,{modelValue:o.notes,"onUpdate:modelValue":e[6]||(e[6]=s=>o.notes=s),type:"textarea",rows:"3"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])}}},he=ee(ve,[["__scopeId","data-v-d2eacf62"]]);export{he as default};
